services:
  # jenkins_main:
  #   image: jenkins/jenkins:lts
  #   ports:
  #   - 8007:8080
  #   - 50000:50000
  #   container_name: jenkins
  #   networks:
  #     - llama-net
  #   volumes:
  #     - ./jenkins_data:/var/jenkins_home

  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: gitlab
    restart: unless-stopped
    hostname: spark0.conornet.co
    networks:
        - llama-net
        - gitlab-net
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # External URL configuration
        external_url 'http://spark0.conornet.co:8005'
        
        # Basic security settings
        gitlab_rails['time_zone'] = 'UTC'
        gitlab_rails['backup_keep_time'] = 604800  # 7 days
    ports:
      - "8005:8005"
      - "443:443"
    volumes:
      - ./gitlab/gitlab_config:/etc/gitlab
      - ./gitlab/gitlab_logs:/var/log/gitlab
      - ./gitlab/gitlab_data:/var/opt/gitlab
      # Optional: Mount custom SSL certificates (see notes below)
      # - ./ssl:/etc/gitlab/ssl:ro
      # root
      # MyNewSecurePassword123!

    # Optional: Add healthcheck
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/-/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  gitlab-runner:
    image: gitlab/gitlab-runner:alpine
    networks:
        - gitlab-net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./gitlab/runner_config:/etc/gitlab-runner:ro

  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    networks:
        - llama-net
    environment:
      POSTGRES_USER: n8n
      POSTGRES_PASSWORD: n8n
      POSTGRES_DB: n8n
    volumes:
      - ./postgres_data:/var/lib/postgresql/data

  n8n:
    image: n8nio/n8n:latest
    restart: unless-stopped
    networks:
        - llama-net
    depends_on:
      - postgres
    ports:
      - "5678:5678"
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: "5432"
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_USER: n8n
      DB_POSTGRESDB_PASSWORD: n8n
      N8N_PORT: "5678"
      N8N_PROTOCOL: http
      N8N_HOST: 127.0.0.1
      N8N_SECURE_COOKIE: false
      N8N_RESTRICT_FILE_ACCESS_TO: /home/node/n8n_files
      WEBHOOK_URL: http://127.0.0.1:5678/
      GENERIC_TIMEZONE: UTC
      NODE_OPTIONS: "--max-old-space-size=4096"

      TZ: UTC
    volumes:
      - ./n8n_data:/home/node/.n8n
      - ./n8n_files:/home/node/n8n_files

  qdrant:
    image: qdrant/qdrant:latest
    restart: always
    container_name: qdrant
    networks:
      - llama-net
    environment:
      QDRANT__GPU__INDEXING: 1
    ports:
      - 6333:6333
      - 6334:6334
    configs:
      - source: qdrant_config
        target: /qdrant/config/production.yaml
    volumes:
      - ./qdrant_data:/qdrant/storage

networks:
  llama-net:
    external: true
    name: llama-net
  gitlab-net:
    name: gitlab-net


configs:
  qdrant_config:
    content: |
      log_level: INFO